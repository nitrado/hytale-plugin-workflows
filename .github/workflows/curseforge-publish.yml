name: CurseForge Publish (Reusable)

on:
  workflow_call:
    inputs:
      artifact-name:
        description: "Name of the artifact to download (from a previous job)"
        type: string
        default: "build-artifacts"
      artifact-id:
        description: "The artifact ID (jar name prefix)"
        type: string
        required: true
      version:
        description: "The version to publish"
        type: string
        required: true
      release-type:
        description: "The release type (release|beta|alpha)"
        type: string
        default: "release"
      game-endpoint:
        description: "The subdomain of curseforge.com (e.g., minecraft, kerbal, hytale)"
        type: string
        default: "hytale"
      game-versions:
        description: "Game version IDs (comma-separated)"
        type: string
        default: "1.0-SNAPSHOT"
      changelog:
        description: "Changelog for this version"
        type: string
        default: "Automated Build & Release from GitHub"
      changelog-type:
        description: "The type of changelog (text|html|markdown)"
        type: string
        default: "markdown"
      relations:
        description: "Project relations (format: projectslug:relationType, comma-separated)"
        type: string
        default: ""
    secrets:
      CURSEFORGE_TOKEN:
        description: "CurseForge API token for authentication"
        required: false
      CURSEFORGE_PROJECT_ID:
        description: "CurseForge project ID (numerical)"
        required: false

jobs:
  publish-curseforge:
    if: ${{ github.repository != 'nitrado/hytale-plugin-workflows' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.artifact-name }}

      - name: Upload to CurseForge
        env:
          CURSEFORGE_TOKEN: ${{ secrets.CURSEFORGE_TOKEN }}
          CURSEFORGE_PROJECT_ID: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          CHANGELOG: ${{ inputs.changelog }}
        run: |
          # Check if secrets are configured
          if [[ -z "$CURSEFORGE_TOKEN" || -z "$CURSEFORGE_PROJECT_ID" ]]; then
            echo "CurseForge secrets not configured, skipping publish"
            exit 0
          fi
          
          # Find the built jar
          JAR_PATH=$(find . -name "${{ inputs.artifact-id }}-${{ inputs.version }}.jar" -print | head -n 1)
          
          if [[ -z "$JAR_PATH" ]]; then
            echo "ERROR: Could not find jar file matching ${{ inputs.artifact-id }}-${{ inputs.version }}.jar"
            echo "Available files:"
            find . -name "*.jar" -print
            exit 1
          fi
          
          echo "Found Jar: $JAR_PATH"
          echo "Publishing Version: ${{ inputs.version }}"
          echo "Game Versions: ${{ inputs.game-versions }}"
          
          # Build game versions array
          GAME_VERSIONS_JSON="[]"
          if [[ -n "${{ inputs.game-versions }}" ]]; then
            GAME_VERSIONS_JSON=$(echo "${{ inputs.game-versions }}" | tr ',' '\n' | jq -R . | jq -s .)
          fi
          
          # Build relations array
          RELATIONS_JSON="[]"
          if [[ -n "${{ inputs.relations }}" ]]; then
            RELATIONS_JSON=$(echo "${{ inputs.relations }}" | tr ',' '\n' | while read -r relation; do
              slug=$(echo "$relation" | cut -d: -f1)
              type=$(echo "$relation" | cut -d: -f2)
              echo "{\"slug\": \"$slug\", \"type\": \"$type\"}"
            done | jq -s .)
          fi
          
          # Write changelog to temp file to handle all special characters safely
          CHANGELOG_FILE=$(mktemp)
          printf '%s' "$CHANGELOG" > "$CHANGELOG_FILE"
          trap 'rm -f "$CHANGELOG_FILE" metadata.json' EXIT
          
          # Build metadata JSON
          cat > metadata.json << EOF
          {
            "changelog": $(jq -Rs . < "$CHANGELOG_FILE"),
            "changelogType": "${{ inputs.changelog-type }}",
            "displayName": "${{ inputs.artifact-id }}-${{ inputs.version }}",
            "gameVersions": $GAME_VERSIONS_JSON,
            "releaseType": "${{ inputs.release-type }}",
            "relations": {
              "projects": $RELATIONS_JSON
            }
          }
          EOF
          
          echo "Metadata:"
          cat metadata.json
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ inputs.game-endpoint }}.curseforge.com/api/projects/$CURSEFORGE_PROJECT_ID/upload-file/" \
            -H "X-Api-Token: $CURSEFORGE_TOKEN" \
            -F "metadata=<metadata.json" \
            -F "file=@$JAR_PATH")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"
          
          if [[ "$HTTP_CODE" -ge 200 && "$HTTP_CODE" -lt 300 ]]; then
            echo "Successfully published to CurseForge!"
          else
            echo "ERROR: Failed to publish to CurseForge (HTTP $HTTP_CODE)"
            exit 1
          fi

